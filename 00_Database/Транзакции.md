**Транзакция** – способ группировки нескольких операций записи и чтения в одну логическую единицу. 

##### <mark style="background: #FFB86CA6;">Что дает:</mark>
- упрощает обработку ошибок, поскольку нет нужды заботиться о частичных отказах, когда часть операций завершилась успешно, а часть – нет

##### Ключевые свойства транзакций описывает акроним `ACID`:

- atomicity (атомарность) – транзакция или полностью выполняется, или полностью не выполняется, например, при разрыве соединения. Частичного выполнения транзакции быть не может. 

- consistency (согласованность) – транзакция должна переводить БД из одного согласованного состояния в другое. Например, при добавлении строки в таблицу `orders`, в столбце `product_id` будет указан ID из таблицы `products` – типичный foreign key. Если продукт, скажем, был удалён из ассортимента, и, соответственно, из БД, то операция вставки строки не должна случиться, и мы получим ошибку.

- isolation (изоляция) – позволяет выполнять параллельные транзакции как последовательные. Изменения одной транзакции не должны быть видны другим транзакциям, пока первая не завершится.

- durability (надежность) – после завершения транзакции все ее изменения должны быть сохранены даже в случае сбоя системы.




![[Pasted image 20240723140326.png]]
На рисунке выше нарушение изоляции: одна транзакция читает результаты незафиксированных операций записи другой транзакции (*грязная* операция записи).
______


![[Pasted image 20240723141216.png]]

Атомарность гарантирует, что в случае возникновения ошибки все ранее выполненные операции записи данной транзакции откатываются во избежание несогласованности состояния БД.
_______

Транзакции, не затрагивающие одних и тех же данных, могут спокойно выполняться конкурентно, поскольку не зависят друг от друга. 

**Проблемы состояния гонки возникают когда:**
- одна транзакция читает данные, модифицируемые в этот момент другой
- эти транзакции пытаются одновременно изменить одни и те же данные


Изолированность транзакции показывает то, насколько сильно влияют друг на друга параллельно выполняющиеся транзакции. Тут надо выбирать что важнее скорость или согласованность – чем выше согласованность, тем ниже скорость. 
##### Уровни изоляции

- read uncommited – чтение незафиксированных данных. Предотвращает "грязные" операции записи, но не "грязные" операции чтения. Самая быстрая, самая низкая согласованность. Не поддерживается Postgtres.

- read commited – операции записи, выполняемые транзакцией, становятся видны другим транзакциям только после фиксации данной. Не решает проблемы, такие как потеря обновлений и непредвиденное чтение. Транзакция должна ждать, пока другая параллельная транзакция не подтвердит свои изменения, прежде чем получить доступ к этим данным.![[Pasted image 20240723170219.png]]User 1 видит новое значение `x` только после фиксации результатов транзакции.


- repeatable read – гарантирует, что при повторном чтении тех же данных в рамках одной транзакции они не изменятся. Он предотвращает грязное чтение и потерю обновлений, но не решает проблему непредвиденного чтения. Другие транзакции по-прежнему могут вносить изменения, которые будут видны только после завершения текущей транзакции.

- serializable – самый строгий уровень изоляции, гарантирующий, что транзакции обрабатываются так, как если бы они выполнялись по очереди, один за другим. Он предотвращает все проблемы, связанные с параллелизмом, включая грязное чтение, потерю обновлений и непредвиденное чтение. Однако этот уровень изоляции может привести к снижению параллелизма и конкуренции, поскольку транзакции должны ожидать завершения предыдущих транзакций.

- snapshot – этот уровень изоляции позволяет транзакции видеть данные в определенный момент времени, создавая "снимок" базы данных. Транзакции могут читать данные из этого снимка, не блокируя другие транзакции, вносящие изменения. Этот уровень изоляции обычно используется в системах, реализующих многоверсионное управление данными (MVCC).

